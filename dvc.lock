schema: '2.0'
stages:
  prepare:
    cmd: python3 -m scripts.preprocessing.prepare
    deps:
    - path: ./scripts/preprocessing/prepare.py
      md5: 1b59bff783e37dafd132321dfb5a50a4
      size: 21341
    params:
      params.yaml:
        prepare:
          SPLIT_SEED: 42
          SETS:
          - - HSC
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          - - HSC_TNG100
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          - - HSC_TNG50
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          MATCHING_FIELDS:
          - - photoz
            - i_cmodel_mag_ge
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          MATCHING_UNCERTAINTIES:
          - - 0.07
            - 0.1
            - 5
          MATCHING_SOURCE_SETS:
          - HSC
          MATCHING_TARGET_SETS:
          - HSC_TNG100
          - HSC_TNG50
          OBSERVABLES:
          - None
          - None
          - None
          UNOBSERVABLES:
          - - photoz
            - i_cmodel_mag_ge
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          LABELS:
          - z
          - i_band_mag
          - petro_90_radius
          ROOT_DESCENDANT_SPLIT: true
    outs:
    - path: ./dataset/
      md5: 56dd072b3d12f68c69ebd4cf7d7ca6ac.dir
      size: 140483535
      nfiles: 14
    - path: ./plots/preprocessing/
      md5: 46723755e4f038389514c49150e3efb4.dir
      size: 33410093
      nfiles: 10
  train_clr:
    cmd: python3 -m scripts.model.train_clr
    deps:
    - path: ./dataset/
      md5: 56dd072b3d12f68c69ebd4cf7d7ca6ac.dir
      size: 140483535
      nfiles: 14
    - path: ./scripts/model/losses.py
      md5: 36be0f287435a461abbcbcddd7226b95
      size: 6012
    - path: ./scripts/model/resnet.py
      md5: 120d0671926e2a1d48588c01eff15109
      size: 16265
    - path: ./scripts/model/resnet_simclr.py
      md5: d1c4e86d37cb48fca285f3427a080556
      size: 4471
    - path: ./scripts/model/train_clr.py
      md5: a954a6eae77c52fb7b44ee76990a14e0
      size: 8853
    - path: ./scripts/model/training.py
      md5: bc6fe2cf022141dbb3e161cb1379a511
      size: 6522
    params:
      params.yaml:
        data:
          VALID_RANGE:
          - None
          - None
          - None
          DATASET: SingleStretchDataset
          FILTERS:
          - I
          - R
          - G
          IMAGE_SIZE: 128
          NUM_WORKERS: 16
        losses:
          mmd_kernel_type: inverse_multiquadratic
          mmd_kernels:
          - - 0.2
            - 0.1
          - - 0.2
            - 0.5
          - - 0.2
            - 2
          adaption_type: huber_linear_mmd
          lambd_clr_train: 1.0
          lambd_clr_domain: 0.0
          lambd_clr_adaption: 0.0
          lambd_max_likelihood: 1.0
          lambd_mmd_forw: 0.0
          lambd_mmd_back: 0.0
          lambd_mae: 0.0
          lambd_mse: 0.0
          nce_temperature: 0.07
        model:
          CLAMP: 1.0
          NUM_COUPLING_LAYERS: 12
          NUM_COND_NODES: 128
          NUM_HIDDEN_NODES: 128
          NUM_HIDDEN_LAYERS: 2
          DROPOUT: 0.0
          BATCH_NORM: false
          NUM_HIDDEN_NODES_COND: 128
          NUM_HIDDEN_LAYERS_COND: 2
          DROPOUT_COND: 0.0
          BATCH_NORM_COND: false
          NUM_HIDDEN_NODES_MLP: 128
          NUM_HIDDEN_LAYERS_MLP: 2
          DROPOUT_MLP: 0.0
          BATCH_NORM_MLP: false
          RESNET_DEPTH: 16
          RESNET_WIDTH: 2
          RESNET_DROPOUT: 0.3
          RESNET_REPRESENTATION_DIM: 128
          RESNET_REPRESENTATION_DEPTH: 3
          RESNET_PROJECTION_DIM: 64
          RESNET_PROJECTION_DEPTH: 2
          RESNET_NUM_CHANNELS: 3
          RESNET_ROTATION_EQUIVARIANCE: 8
          RESNET_ROTATION_RESTRICTION: 0
          RESNET_REFLECTION_EQUIVARIANCE: true
          RESNET_INITIAL_STRIDE: 2
        train_clr:
          LEARNING_RATE: 0.00015
          L2_DECAY: 6e-05
          BETA_1: 0.9
          BETA_2: 0.999
          LR_PATIENCE: 5
          LR_DECAY: 0.6
          BATCH_SIZE: 32
          NUM_EPOCHS: 500
          MAX_NUM_BATCHES_PER_EPOCH: 200
          MAX_RUNTIME_SECONDS: 43200
          PATIENCE: 20
          PARALLEL_TRAINING: false
          DOMAIN_TRAINING: true
          DOMAIN_ADAPTION: false
          CLR_TYPE: NNCLR
          NNCLR_QUEUE_SIZE: 512
          AUGMENTATION_PARAMS:
            ROTATION: 15
            TRANSLATE: 0.36
            SCALE: 1.9
            FLIP: true
            GAUSSIAN_BLUR_SIGMA:
            - 0.001
            - 6.5
            NOISE_STD:
            - 0.01
            - 0.08
    outs:
    - path: ./model/resnet.pt
      md5: c17432e1a4bc67e30cf986a5415509a7
      size: 137715580
  write_representation:
    cmd: python3 -m scripts.postprocessing.write_representation
    deps:
    - path: ./dataset/
      md5: 56dd072b3d12f68c69ebd4cf7d7ca6ac.dir
      size: 140483535
      nfiles: 14
    - path: ./model/resnet.pt
      md5: c17432e1a4bc67e30cf986a5415509a7
      size: 137715580
    - path: ./scripts/postprocessing/write_representation.py
      md5: 9920287255e7a4ce6bb6b3c2f67bbdba
      size: 901
    outs:
    - path: ./postprocessing/representation.npy
      md5: 5316968f3dec6277791f425ee41e4a51
      size: 9824384
