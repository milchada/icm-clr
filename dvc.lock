schema: '2.0'
stages:
  prepare:
    cmd: python3 -m scripts.preprocessing.prepare
    deps:
    - path: ./scripts/preprocessing/prepare.py
      hash: md5
      md5: 22c3e8e267a3076fa13cdd3129b5f9f8
      size: 22070
    params:
      params.yaml:
        prepare:
          SPLIT_SEED: 42
          SETS:
          - - Xray-TNG-Cluster
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          MATCHING_SOURCE_SETS:
          - None
          MATCHING_TARGET_SETS:
          - None
          MATCHING_FIELDS: None
          MATCHING_UNCERTAINTIES: None
          OBSERVABLES:
          - None
          UNOBSERVABLES:
          - None
          LABELS:
          - z
          - gas_mass
          - stellar_mass
          - bh_mass
          - m200c
          - m500c
          - bh_accr
          ROOT_DESCENDANT_SPLIT: true
    outs:
    - path: ./dataset/
      hash: md5
      md5: fcb28edf77b73469174b151b7a5b1741.dir
      size: 2892897
      nfiles: 14
  train_clr:
    cmd: python3 -m scripts.model.train_clr
    deps:
    - path: ./dataset/
      hash: md5
      md5: fcb28edf77b73469174b151b7a5b1741.dir
      size: 2892897
      nfiles: 14
    - path: ./scripts/model/
      hash: md5
      md5: 10070b54f842dacab686d702e136d2f7.dir
      size: 139120656
      nfiles: 36
    params:
      params.yaml:
        data:
          VALID_RANGE:
          - None
          DATASET: SingleStretchDataset
          FILTERS:
          - 0.5-5.0
          IMAGE_SIZE: 128
          NUM_WORKERS: 16
        losses:
          mmd_kernel_type: inverse_multiquadratic
          mmd_kernels:
          - - 0.2
            - 0.1
          - - 0.2
            - 0.5
          - - 0.2
            - 2
          adaption_type: huber_linear_mmd
          lambd_clr_train: 1.0
          lambd_clr_domain: 0.0
          lambd_clr_adaption: 0.0
          lambd_max_likelihood: 1.0
          lambd_mmd_forw: 0.0
          lambd_mmd_back: 0.0
          lambd_mae: 0.0
          lambd_mse: 0.0
          nce_temperature: 0.04
        model:
          CLAMP: 1.0
          NUM_COUPLING_LAYERS: 12
          NUM_COND_NODES: 128
          NUM_HIDDEN_NODES: 128
          NUM_HIDDEN_LAYERS: 2
          DROPOUT: 0.0
          BATCH_NORM: false
          NUM_HIDDEN_NODES_COND: 128
          NUM_HIDDEN_LAYERS_COND: 2
          DROPOUT_COND: 0.0
          BATCH_NORM_COND: false
          NUM_HIDDEN_NODES_MLP: 128
          NUM_HIDDEN_LAYERS_MLP: 2
          DROPOUT_MLP: 0.0
          BATCH_NORM_MLP: false
          RESNET_DEPTH: 16
          RESNET_WIDTH: 2
          RESNET_DROPOUT: 0.3
          RESNET_REPRESENTATION_DIM: 256
          RESNET_REPRESENTATION_DEPTH: 2
          RESNET_PROJECTION_DIM: 256
          RESNET_PROJECTION_DEPTH: 2
          RESNET_NUM_CHANNELS: 1
          RESNET_ROTATION_EQUIVARIANCE: 8
          RESNET_ROTATION_RESTRICTION: 0
          RESNET_REFLECTION_EQUIVARIANCE: true
          RESNET_INITIAL_STRIDE: 2
        train_clr:
          LEARNING_RATE: 0.001
          L2_DECAY: 1e-06
          BETA_1: 0.9
          BETA_2: 0.999
          LR_PATIENCE: 3
          LR_DECAY: 0.8
          BATCH_SIZE: 32
          NUM_EPOCHS: 500
          MAX_NUM_BATCHES_PER_EPOCH: 350
          MAX_RUNTIME_SECONDS: 86400
          PATIENCE: 15
          PARALLEL_TRAINING: false
          DOMAIN_TRAINING: true
          DOMAIN_ADAPTION: false
          CLR_TYPE: NNCLR
          NNCLR_QUEUE_SIZE: 512
          AUGMENTATION_PARAMS:
            ROTATION: 15
            TRANSLATE: 0.25
            SCALE: 1.1
            FLIP: true
            GAUSSIAN_BLUR_SIGMA:
            - 0.0001
            - 0.1
            NOISE_STD:
            - 0.01
            - 0.08
            CLIP_DELTA: 5
    outs:
    - path: ./model/resnet.pt
      hash: md5
      md5: b41c0ef2f051597e4293a9d611c07d58
      size: 138917122
  write_representation:
    cmd: python3 -m scripts.postprocessing.write_representation
    deps:
    - path: ./dataset/
      hash: md5
      md5: fcb28edf77b73469174b151b7a5b1741.dir
      size: 2892897
      nfiles: 14
    - path: ./model/resnet.pt
      hash: md5
      md5: b41c0ef2f051597e4293a9d611c07d58
      size: 138917122
    - path: ./scripts/postprocessing/write_representation.py
      hash: md5
      md5: ee37623f03398d843f372b93129ed1c1
      size: 2400
    outs:
    - path: ./postprocessing/representation.npy
      hash: md5
      md5: c8f2b0ae6ac38c98cfedb42f8ec9d1e0
      size: 395392
  params_opt:
    cmd: sbatch -W run_params_opt.sh
    deps:
    - path: ./dataset/
      hash: md5
      md5: ae3d3c536ea8df227d354bc93193614b.dir
      size: 251064135
      nfiles: 14
    - path: ./scripts/model/
      hash: md5
      md5: 93fa1d1b612997510fc49a7d669c1429.dir
      size: 174268
      nfiles: 33
    params:
      params.yaml:
        params_opt:
          STUDY_NAME: Final_Variation_Study
          STUDY_OBJECT: ParameterOptimizationCLR_All
          NUM_TRIALS: 200
          SAVE_MODELS: true
    outs:
    - path: ./metrics/optuna_journal.log
      hash: md5
      md5: 7d22d271e7a5a5121d0396db5269375f
      size: 3054684
    - path: ./model/optuna/
      hash: md5
      md5: 043360741c27ac12b7be3d696ebb8eb0.dir
      size: 10003616636
      nfiles: 161
  write_optuna_representation:
    cmd: python3 -m scripts.postprocessing.write_optuna_representation
    deps:
    - path: ./dataset/
      hash: md5
      md5: ae3d3c536ea8df227d354bc93193614b.dir
      size: 251064135
      nfiles: 14
    - path: ./model/optuna/
      hash: md5
      md5: 043360741c27ac12b7be3d696ebb8eb0.dir
      size: 10003616636
      nfiles: 161
    - path: ./scripts/postprocessing/write_optuna_representation.py
      hash: md5
      md5: d0f50fc030463257f90379a7f9b28fea
      size: 1508
    outs:
    - path: ./postprocessing/optuna/
      hash: md5
      md5: 2965eec25ea8ff6f2c0a301f8fe03ce8.dir
      size: 242509440
      nfiles: 15
