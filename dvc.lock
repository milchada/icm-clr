schema: '2.0'
stages:
  prepare:
    cmd: python3 -m scripts.preprocessing.prepare
    deps:
    - path: ./scripts/preprocessing/prepare.py
      hash: md5
      md5: e765c08fd67d7c5d5adec1d744df52ec
      size: 21985
    params:
      params.yaml:
        prepare:
          SPLIT_SEED: 42
          SETS:
          - - HSC
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          - - HSC_TNG100
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          - - HSC_TNG50
            - - 0.8
              - 0.0
              - 0.1
              - 0.1
          MATCHING_FIELDS:
          - - photoz
            - i_cmodel_mag_ge
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          MATCHING_UNCERTAINTIES:
          - - 0.01
            - 0.1
            - 5
          MATCHING_SOURCE_SETS:
          - HSC
          MATCHING_TARGET_SETS:
          - HSC_TNG100
          - HSC_TNG50
          OBSERVABLES:
          - None
          - None
          - None
          UNOBSERVABLES:
          - - photoz
            - i_cmodel_mag_ge
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          - - z
            - i_band_mag_dust_apparent
            - petro_90_light
          LABELS:
          - z
          - i_band_mag
          - petro_90_radius
          ROOT_DESCENDANT_SPLIT: true
    outs:
    - path: ./dataset/
      hash: md5
      md5: 7251ba129945983eda5613cff8a1af77.dir
      size: 251064135
      nfiles: 14
    - path: ./plots/preprocessing/
      hash: md5
      md5: b4232fd78b6e5c941dc1bdd9f9f228b0.dir
      size: 57990892
      nfiles: 10
  train_clr:
    cmd: python3 -m scripts.model.train_clr
    deps:
    - path: ./dataset/
      hash: md5
      md5: ae3d3c536ea8df227d354bc93193614b.dir
      size: 251064135
      nfiles: 14
    - path: ./scripts/model/
      hash: md5
      md5: d7a3ef3eb2252a6670847c59df809788.dir
      size: 174352
      nfiles: 33
    params:
      params.yaml:
        data:
          VALID_RANGE:
          - None
          - None
          - None
          DATASET: SingleStretchDataset
          FILTERS:
          - I
          - R
          - G
          IMAGE_SIZE: 128
          NUM_WORKERS: 16
        losses:
          mmd_kernel_type: inverse_multiquadratic
          mmd_kernels:
          - - 0.2
            - 0.1
          - - 0.2
            - 0.5
          - - 0.2
            - 2
          adaption_type: huber_linear_mmd
          lambd_clr_train: 1.0
          lambd_clr_domain: 0.0
          lambd_clr_adaption: 0.0
          lambd_max_likelihood: 1.0
          lambd_mmd_forw: 0.0
          lambd_mmd_back: 0.0
          lambd_mae: 0.0
          lambd_mse: 0.0
          nce_temperature: 0.04
        model:
          CLAMP: 1.0
          NUM_COUPLING_LAYERS: 12
          NUM_COND_NODES: 128
          NUM_HIDDEN_NODES: 128
          NUM_HIDDEN_LAYERS: 2
          DROPOUT: 0.0
          BATCH_NORM: false
          NUM_HIDDEN_NODES_COND: 128
          NUM_HIDDEN_LAYERS_COND: 2
          DROPOUT_COND: 0.0
          BATCH_NORM_COND: false
          NUM_HIDDEN_NODES_MLP: 128
          NUM_HIDDEN_LAYERS_MLP: 2
          DROPOUT_MLP: 0.0
          BATCH_NORM_MLP: false
          RESNET_DEPTH: 16
          RESNET_WIDTH: 2
          RESNET_DROPOUT: 0.3
          RESNET_REPRESENTATION_DIM: 256
          RESNET_REPRESENTATION_DEPTH: 2
          RESNET_PROJECTION_DIM: 256
          RESNET_PROJECTION_DEPTH: 2
          RESNET_NUM_CHANNELS: 3
          RESNET_ROTATION_EQUIVARIANCE: 8
          RESNET_ROTATION_RESTRICTION: 0
          RESNET_REFLECTION_EQUIVARIANCE: true
          RESNET_INITIAL_STRIDE: 2
        train_clr:
          LEARNING_RATE: 0.001
          L2_DECAY: 1e-06
          BETA_1: 0.9
          BETA_2: 0.999
          LR_PATIENCE: 3
          LR_DECAY: 0.8
          BATCH_SIZE: 32
          NUM_EPOCHS: 500
          MAX_NUM_BATCHES_PER_EPOCH: 350
          MAX_RUNTIME_SECONDS: 86400
          PATIENCE: 15
          PARALLEL_TRAINING: false
          DOMAIN_TRAINING: true
          DOMAIN_ADAPTION: false
          CLR_TYPE: NNCLR
          NNCLR_QUEUE_SIZE: 512
          AUGMENTATION_PARAMS:
            ROTATION: 15
            TRANSLATE: 0.25
            SCALE: 1.1
            FLIP: true
            GAUSSIAN_BLUR_SIGMA:
            - 0.0001
            - 0.1
            NOISE_STD:
            - 0.01
            - 0.08
    outs:
    - path: ./model/resnet.pt
      hash: md5
      md5: 75b7064b05dc49792659b76f72f34950
      size: 138930562
  write_representation:
    cmd: python3 -m scripts.postprocessing.write_representation
    deps:
    - path: ./dataset/
      hash: md5
      md5: ae3d3c536ea8df227d354bc93193614b.dir
      size: 251064135
      nfiles: 14
    - path: ./model/resnet.pt
      hash: md5
      md5: 75b7064b05dc49792659b76f72f34950
      size: 138930562
    - path: ./scripts/postprocessing/write_representation.py
      md5: 442ab6763d87ec824eab91847254cb5d
      size: 1173
    outs:
    - path: ./postprocessing/representation.npy
      hash: md5
      md5: badc3124cce3af80569ad7919d2dbee0
      size: 32334464
  params_opt:
    cmd: sbatch -W run_params_opt.sh
    deps:
    - path: ./dataset/
      hash: md5
      md5: ae3d3c536ea8df227d354bc93193614b.dir
      size: 251064135
      nfiles: 14
    - path: ./scripts/model/
      hash: md5
      md5: 93fa1d1b612997510fc49a7d669c1429.dir
      size: 174268
      nfiles: 33
    params:
      params.yaml:
        params_opt:
          STUDY_NAME: Final_Variation_Study
          STUDY_OBJECT: ParameterOptimizationCLR_All
          NUM_TRIALS: 200
          SAVE_MODELS: true
    outs:
    - path: ./metrics/optuna_journal.log
      hash: md5
      md5: 7d22d271e7a5a5121d0396db5269375f
      size: 3054684
    - path: ./model/optuna/
      hash: md5
      md5: 043360741c27ac12b7be3d696ebb8eb0.dir
      size: 10003616636
      nfiles: 161
  write_optuna_representation:
    cmd: python3 -m scripts.postprocessing.write_optuna_representation
    deps:
    - path: ./dataset/
      hash: md5
      md5: ae3d3c536ea8df227d354bc93193614b.dir
      size: 251064135
      nfiles: 14
    - path: ./model/optuna/
      hash: md5
      md5: 043360741c27ac12b7be3d696ebb8eb0.dir
      size: 10003616636
      nfiles: 161
    - path: ./scripts/postprocessing/write_optuna_representation.py
      hash: md5
      md5: d0f50fc030463257f90379a7f9b28fea
      size: 1508
    outs:
    - path: ./postprocessing/optuna/
      hash: md5
      md5: 2965eec25ea8ff6f2c0a301f8fe03ce8.dir
      size: 242509440
      nfiles: 15
  train_cinn:
    cmd: python3 -m scripts.model.train_cinn
    deps:
    - path: ./dataset/
      hash: md5
      md5: 7251ba129945983eda5613cff8a1af77.dir
      size: 251064135
      nfiles: 14
    - path: ./model/resnet.pt
      hash: md5
      md5: 75b7064b05dc49792659b76f72f34950
      size: 138930562
    - path: ./scripts/model/
      hash: md5
      md5: e4728d0c002ef7c1cecb523b75ba3f19.dir
      size: 171014
      nfiles: 33
    params:
      params.yaml:
        data:
          VALID_RANGE:
          - None
          - None
          - None
          DATASET: SingleStretchDataset
          FILTERS:
          - I
          - R
          - G
          IMAGE_SIZE: 128
          NUM_WORKERS: 16
        losses:
          mmd_kernel_type: inverse_multiquadratic
          mmd_kernels:
          - - 0.2
            - 0.1
          - - 0.2
            - 0.5
          - - 0.2
            - 2
          adaption_type: huber_linear_mmd
          lambd_clr_train: 1.0
          lambd_clr_domain: 0.0
          lambd_clr_adaption: 0.0
          lambd_max_likelihood: 1.0
          lambd_mmd_forw: 0.0
          lambd_mmd_back: 0.0
          lambd_mae: 0.0
          lambd_mse: 0.0
          nce_temperature: 0.04
        model:
          CLAMP: 1.0
          NUM_COUPLING_LAYERS: 12
          NUM_COND_NODES: 128
          NUM_HIDDEN_NODES: 128
          NUM_HIDDEN_LAYERS: 2
          DROPOUT: 0.0
          BATCH_NORM: false
          NUM_HIDDEN_NODES_COND: 128
          NUM_HIDDEN_LAYERS_COND: 2
          DROPOUT_COND: 0.0
          BATCH_NORM_COND: false
          NUM_HIDDEN_NODES_MLP: 128
          NUM_HIDDEN_LAYERS_MLP: 2
          DROPOUT_MLP: 0.0
          BATCH_NORM_MLP: false
          RESNET_DEPTH: 16
          RESNET_WIDTH: 2
          RESNET_DROPOUT: 0.3
          RESNET_REPRESENTATION_DIM: 256
          RESNET_REPRESENTATION_DEPTH: 2
          RESNET_PROJECTION_DIM: 256
          RESNET_PROJECTION_DEPTH: 2
          RESNET_NUM_CHANNELS: 3
          RESNET_ROTATION_EQUIVARIANCE: 8
          RESNET_ROTATION_RESTRICTION: 0
          RESNET_REFLECTION_EQUIVARIANCE: true
          RESNET_INITIAL_STRIDE: 2
        train_cinn:
          L2_DECAY: 0.0002
          BETA_1: 0.9
          BETA_2: 0.999
          LEARNING_RATE: 0.002
          LR_PATIENCE: 5
          LR_DECAY: 0.5
          NUM_EPOCHS: 200
          PATIENCE: 20
          MAX_NUM_BATCHES_PER_EPOCH: 350
          MAX_RUNTIME_SECONDS: 86400
          USE_PRETRAINED_RESNET: true
          FIX_RESNET_PARAMS: true
          RESNET_LR_THRESHOLD: 0
          BATCH_SIZE: 128
          NOISE: 0.0
          NUM_MODELS: 1
          AUGMENTATION_PARAMS:
            ROTATION: 10
            TRANSLATE: 0.11
            SCALE: 1.1
            FLIP: true
            GAUSSIAN_BLUR_SIGMA:
            - 1e-06
            - 0.1
            NOISE_STD:
            - 0.0
            - 0.05
    outs:
    - path: ./model/cinn/
      hash: md5
      md5: 155455c065cda16b4cb27719066be496.dir
      size: 144165251
      nfiles: 1
  sample_posterior:
    cmd: python3 -m scripts.postprocessing.sample_posterior
    deps:
    - path: ./dataset/
      hash: md5
      md5: 7251ba129945983eda5613cff8a1af77.dir
      size: 251064135
      nfiles: 14
    - path: ./model/cinn/
      hash: md5
      md5: 155455c065cda16b4cb27719066be496.dir
      size: 144165251
      nfiles: 1
    - path: ./scripts/postprocessing/sample_posterior.py
      hash: md5
      md5: 34ff6c7254b976227471cb3db3216d5a
      size: 3281
    params:
      params.yaml:
        sample_posterior:
          NUM_SAMPLES: 400
    outs:
    - path: ./postprocessing/posterior.npy
      hash: md5
      md5: 2055b2fcb2c84962fce50784f59bf21b
      size: 606268928
